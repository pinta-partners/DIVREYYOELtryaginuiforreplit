<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chasiddus AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@100..900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:ital,opsz,wght@0,8..144,100..900;1,8..144,100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-gray-50" dir="rtl">
    <div id="app" data-v-app="">
      <header class="bg-gradient-to-r from-blue-700 to-blue-1000 h-14 relative shadow-custom">
        <div class="max-w-screen-xl mx-auto h-full flex items-center justify-between h-10 px-3 sm:px-0">
          <div class="answer flex-1">
          </div>
        </div>
      </header>
      <div class="max-w-2xl mx-auto flex flex-col gap-4 mb-4 px-3 sm:px-0">
        <div class="flex gap-3 mt-4">
          <div class="flex justify-center items-center rounded-full h-[42px] w-[42px] align-content bg-blue-500">
            DG
          </div>
          <div class="bg-gray-100 rounded-2xl p-3 f-narkis flex-1 text-lg">
            <form id="query-form" class="w-full">
              <textarea id="question" name="question" class="w-full bg-transparent border-none outline-none resize-none f-narkis text-lg focus:ring-0 focus:outline-none" placeholder="Type your question..." required rows="1"></textarea>
              <div class="flex justify-end mt-2">
                <button type="submit" class="rounded-md whitespace-nowrap inline-flex flex-row gap-1 items-center justify-center h-9 text-sm px-4 bg-blue-500 text-white">
                  Send
                </button>
              </div>
            </form>
          </div>
        </div>

        <div id="result-container" class="result-container"></div>
      </div>
    </div>

    <script>
        const form = document.querySelector("#query-form");
        const resultContainer = document.getElementById("result-container");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const textarea = document.getElementById("question");
            const sendButton = form.querySelector("button");

            textarea.disabled = true;
            textarea.style.cursor = "not-allowed";
            sendButton.style.display = "none";

            const question = textarea.value;

            const aiCard = document.createElement("div");
            aiCard.className = "ai-card";
            aiCard.style.marginBottom = "8px";

            aiCard.innerHTML = `
                <div class="flex gap-3">
                    <div class="flex justify-center items-center rounded-full h-[42px] w-[42px] align-content bg-blue-500">
                        <span class="text-white">AI</span>
                    </div>
                    <div class="ai-bubble flex-1" id="aiBubble">
                        <div class="typing-indicator" id="typingIndicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            resultContainer.appendChild(aiCard);

            let data;
            if (question === "testtest") {
                data = {
                    analysis: {
                        analyzed_passages: [{
                            title: "תינוקות של בית רבן הוא המגן האמיתי על עם ישראל",
                            source: "Divrey Yoel, Torah, Shemot, Torah #3, Passage #31",
                            explanationTitle: "בשורה רעה נתבשרו ישראל באותה שעה, ש",
                            explanation: "ביאור העניין הוא שכח התורה והתפילה של תינוקות של בית רבן הוא המגן האמיתי על עם ישראל מפני אויביהם",
                            passage: "ונקדים דברי המכילתא (פ' בא) והי' כי יאמרו אליכם בניכם מה העבודה הזאת לכם וגו', בשורה רעה נתבשרו ישראל באותה שעה, שסוף עתידה תורה להשתכח ע\"כ, ולכאורה צ\"ב הרי מצות הלילה כן הוא שישאלו הבנים"
                        }]
                    }
                };
            } else {
                const response = await fetch("/process", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `question=${encodeURIComponent(question)}`,
                });
                data = await response.json();
            }

            const aiBubble = document.getElementById("aiBubble");
            const typingIndicator = document.getElementById("typingIndicator");

            if (typingIndicator) {
                typingIndicator.remove();
            }

            if (data.analysis && data.analysis.analyzed_passages) {
                data.analysis.analyzed_passages.forEach((passage, index) => {
                    if (index === 0) {
                        aiBubble.innerHTML = `
                            ${passage.title ? `<div class="bg-white border border-gray-200 rounded-2xl p-4 mb-3 noto-600">${passage.title}</div>` : ''}
                            <div>
                              <div class="bg-white border border-gray-200 rounded-2xl p-4 mb-3 text-lg f-narkis">
                                <div class="flex justify-between">
                                  <div class="inline-block text-sm bg-yellow-100 rounded-sm px-3 py-1 mb-4 noto-500">
                                    ${passage.source}
                                  </div>
                                </div>
                                ${passage.explanationTitle ? `<div class="font-bold">${passage.explanationTitle}</div>` : ''}
                                <span>
                                  <div class="mb-4">${passage.explanation}</div>
                                  <div class="text-xs text-blue-500 noto-500 flex items-center mb-3 cursor-pointer" onclick="toggleExpand('passage-${index}')">
                                    <div>דבריו במלואם</div>
                                  </div>
                                  <div id="passage-${index}" class="hidden">
                                    <hr class="border-t-0 border-b border-b-2 my-4 border-gray-500"/>
                                    <div class="text-xs noto-500 mb-1">סיכום דבריו:</div>
                                    <div>${passage.passage}</div>
                                  </div>
                                </span>
                              </div>
                            </div>
                        `;
                    } else {
                        const additionalCard = document.createElement("div");
                        additionalCard.className = "ai-card";
                        additionalCard.style.marginBottom = "8px";
                        additionalCard.innerHTML = `
                            <div class="ai-bubble">
                                ${passage.title ? `<div class="bg-white border border-gray-200 rounded-2xl p-4 mb-3 noto-600">${passage.title}</div>` : ''}
                                <div class="flex gap-3">
                                    <p class="source">${passage.source}</p>
                                    <p class="hebrew"><strong>סיכום:</strong> ${passage.explanation}</p>
                                    <span class="expand-btn" onclick="toggleExpand('passage-${index}')">View Full Passage</span>
                                    <div id="passage-${index}" class="hidden full-text">${passage.passage}</div>
                                </div>
                            </div>
                        `;
                        resultContainer.appendChild(additionalCard);
                    }
                });
            } else {
                aiBubble.innerHTML = "<p>No analysis available.</p>";
            }
        });

        function toggleExpand(id) {
            const element = document.getElementById(id);
            element.classList.toggle("hidden");
            const expandBtn = element.previousElementSibling;
            expandBtn.textContent = element.classList.contains("hidden") ? "דבריו במלואם" : "סגור";
        }
    </script>
</body>
</html>