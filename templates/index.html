
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chasiddus AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@100..900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:ital,opsz,wght@0,8..144,100..900;1,8..144,100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-gray-50" dir="rtl">
    <div id="app" data-v-app="">
      <header class="bg-gradient-to-r from-blue-700 to-blue-1000 h-14 relative shadow-custom">
        <div class="max-w-screen-xl mx-auto h-full flex items-center justify-between h-10 px-3 sm:px-0">
        </div>
      </header>
      <div class="max-w-2xl mx-auto flex flex-col gap-4 mb-4 px-3 sm:px-0">
        <h1>Chasiddus AI</h1>
        <h2>Search for any Dvar Torah in Chasidishe Seforim using AI. This version has access to the entire Divrey Yoel.</h2>

        <form id="query-form" class="chat-form">
            <div class="avatar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-user">
                    <circle cx="12" cy="12" r="10" />
                    <circle cx="12" cy="10" r="3" />
                    <path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662" />
                </svg>
            </div>
            <div class="chat-input-container">
                <textarea id="question" name="question" placeholder="Type your question..." required rows="1"></textarea>
                <button type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </form>

        <div id="result-container" class="result-container"></div>
      </div>
    </div>

    <script>
        const form = document.querySelector("#query-form");
        const resultContainer = document.getElementById("result-container");
        let questionAsked = false;

        const showNewQuestionButton = () => {
            const newQuestionDiv = document.createElement('div');
            newQuestionDiv.className = "flex justify-between items-center mt-7";
            newQuestionDiv.innerHTML = `
                <div class="flex justify-end w-full">
                    <button
                        class="rounded-md whitespace-nowrap inline-flex flex-row gap-1 items-center justify-center h-9 text-sm px-4 bg-blue-200 text-gray-800 hover:bg-blue-200/[.80] active:bg-blue-100 active:ring active:ring-blue-200 disabled:bg-blue-200/[.60] disabled:text-gray-800/[.60]"
                        onclick="resetForm()"
                        type="secondary">
                        <div class="inline-block align-middle">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5.75 8C5.75 8.0663 5.72366 8.12989 5.67678 8.17678C5.62989 8.22366 5.5663 8.25 5.5 8.25C5.4337 8.25 5.37011 8.22366 5.32322 8.17678C5.27634 8.12989 5.25 8.0663 5.25 8C5.25 7.9337 5.27634 7.87011 5.32322 7.82322C5.37011 7.77634 5.4337 7.75 5.5 7.75C5.5663 7.75 5.62989 7.77634 5.67678 7.82322C5.72366 7.87011 5.75 7.9337 5.75 8ZM5.75 8H5.5M8.25 8C8.25 8.0663 8.22366 8.12989 8.17678 8.17678C8.12989 8.22366 8.0663 8.25 8 8.25C7.9337 8.25 7.87011 8.22366 7.82322 8.17678C7.77634 8.12989 7.75 8.0663 7.75 8C7.75 7.9337 7.77634 7.87011 7.82322 7.82322C7.87011 7.77634 7.9337 7.75 8 7.75C8.0663 7.75 8.12989 7.77634 8.17678 7.82322C8.22366 7.87011 8.25 7.9337 8.25 8ZM8.25 8H8M10.75 8C10.75 8.0663 10.7237 8.12989 10.6768 8.17678C10.6299 8.22366 10.5663 8.25 10.5 8.25C10.4337 8.25 10.3701 8.22366 10.3232 8.17678C10.2763 8.12989 10.25 8.0663 10.25 8C10.25 7.9337 10.2763 7.87011 10.3232 7.82322C10.3701 7.77634 10.4337 7.75 10.5 7.75C10.5663 7.75 10.6299 7.77634 10.6768 7.82322C10.7237 7.87011 10.75 7.9337 10.75 8ZM10.75 8H10.5M14 8C14 11.0373 11.3133 13.5 8 13.5C7.42479 13.5007 6.85202 13.4252 6.29667 13.2753C5.51384 13.8259 4.55888 14.0761 3.60667 13.98C3.5008 13.9698 3.39538 13.9553 3.29067 13.9367C3.61924 13.5494 3.84365 13.0848 3.94267 12.5867C4.00267 12.282 3.854 11.986 3.63133 11.7693C2.62 10.7853 2 9.45933 2 8C2 4.96267 4.68667 2.5 8 2.5C11.3133 2.5 14 4.96267 14 8Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </div>
                        שאלה חדשה
                    </button>
                </div>
            `;
            resultContainer.insertBefore(newQuestionDiv, resultContainer.firstChild);
        };

        const resetForm = () => {
            form.reset();
            resultContainer.innerHTML = '';
            questionAsked = false;
            const textarea = document.getElementById("question");
            const sendButton = form.querySelector("button");
            textarea.disabled = false;
            textarea.style.cursor = "text";
            sendButton.style.display = "block";
        };

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const textarea = document.getElementById("question");
            const sendButton = form.querySelector("button");

            textarea.disabled = true;
            textarea.style.cursor = "not-allowed";
            sendButton.style.display = "none";

            const question = textarea.value;

            const aiCard = document.createElement("div");
            aiCard.className = "ai-card";
            aiCard.style.marginBottom = "8px";

            aiCard.innerHTML = `
                <div class="ai-bubble" id="aiBubble">
                    <div class="typing-indicator" id="typingIndicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
                <div class="ai-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                </div>
            `;
            resultContainer.appendChild(aiCard);

            const response = await fetch("/process", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `question=${encodeURIComponent(question)}`,
            });
            const data = await response.json();

            const aiBubble = document.getElementById("aiBubble");
            const typingIndicator = document.getElementById("typingIndicator");

            if (typingIndicator) {
                typingIndicator.remove();
            }

            if (data.analysis && data.analysis.analyzed_passages) {
                questionAsked = true;
                showNewQuestionButton();
                data.analysis.analyzed_passages.forEach((passage, index) => {
                    if (index === 0) {
                        aiBubble.innerHTML = `
                            <p class="source">${passage.source}</p>
                            <p class="hebrew"><strong>סיכום:</strong> ${passage.explanation}</p>
                            <span class="expand-btn" onclick="toggleExpand('passage-${index}')">View Full Passage</span>
                            <div id="passage-${index}" class="hidden full-text">${passage.passage}</div>
                        `;
                    } else {
                        const additionalCard = document.createElement("div");
                        additionalCard.className = "ai-card";
                        additionalCard.style.marginBottom = "8px";
                        additionalCard.innerHTML = `
                            <div class="ai-bubble">
                                <p class="source">${passage.source}</p>
                                <p class="hebrew"><strong>סיכום:</strong> ${passage.explanation}</p>
                                <span class="expand-btn" onclick="toggleExpand('passage-${index}')">View Full Passage</span>
                                <div id="passage-${index}" class="hidden full-text">${passage.passage}</div>
                            </div>
                        `;
                        resultContainer.appendChild(additionalCard);
                    }
                });
            } else {
                aiBubble.innerHTML = "<p>No analysis available.</p>";
            }
        });

        function toggleExpand(id) {
            const element = document.getElementById(id);
            element.classList.toggle("hidden");
            const expandBtn = element.previousElementSibling;
            expandBtn.style.display = "none";
        }
    </script>
</body>
</html>
